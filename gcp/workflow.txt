main:
  params: []
  steps:
    - getYesterdayDate:
        call: http.get
        args:
          url: https://europe-north1-team-god.cloudfunctions.net/yesterday_date  # URL of your Cloud Function
        result: yesterdayDate
    - callWeatherAPI:
        call: http.get
        args:
          url: https://ingestion-service-5d5xhd46ea-lz.a.run.app/ingestion
          query:
            location: "Stockholm"
            date: ${yesterdayDate.body}
        result: weatherResponse
    - checkWeatherAPIResponse:
        switch:
          - condition: ${weatherResponse.status == 200}
            next: callBigQueryService
          - condition: ${weatherResponse.status != 200}
            next: handleError
    - callBigQueryService:
        call: http.post
        args:
          url: https://ingestion-service-5d5xhd46ea-lz.a.run.app/bigquery
          body:
            data: ${weatherResponse.body}
        result: bigQueryResponse
    - checkBigQueryResponse:
        switch:
          - condition: ${bigQueryResponse.status == 200}
            next: workflow_end
          - condition: ${bigQueryResponse.status != 200}
            next: handleError
    - handleError:
        raise: '${"Error in workflow execution: " + weatherResponse.status + " or " + bigQueryResponse.status}'
    - workflow_end:
        return: 'Workflow executed successfully'
